<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cambright Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f0f2f5; }
    header { background: #2a8cff; color: #fff; padding: 20px; font-size: 20px; }
    section { padding: 20px; background: #fff; margin-bottom: 10px; }
    button { background: #2a8cff; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #005fcc; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 14px; }
    th { background: #e0e8ff; }
    tr:nth-child(even) { background: #f9f9f9; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-box { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; }
    textarea { width: 100%; height: 100px; }
    .close-btn { background: #e53935; }
    .close-btn:hover { background: #b71c1c; }
  </style>
</head>
<body>
<header>Teacher / Admin Dashboard</header>

<!-- PIN Generator -->
<section>
  <h2>Create 6‑digit Access PIN (valid 30 min)</h2>
  <button onclick="generatePin()">Generate Code</button>
  <strong id="pinDisplay" style="margin-left: 12px;"></strong>
  <span id="pinCountdown" style="margin-left: 12px; color: #e53935;"></span>
</section>

<!-- Submissions Table -->
<section>
  <h2>Submissions</h2>
  <table>
    <thead>
<tr><th>Name</th><th>Email</th><th>Passport</th><th>MCQ</th><th>Writing</th><th>Total</th><th>Action</th><th>Video</th></tr>
    </thead>
    <tbody id="submissionTable"></tbody>
  </table>
</section>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalName"></h3>
    <p>Email: <span id="modalEmail"></span></p>
    <p>Passport: <span id="modalPassport"></span></p>
    <p>MCQ Score: <span id="modalMcq"></span>/26</p>
    <h4>Writing Answer:</h4>
    <textarea id="modalWriting" readonly></textarea>
    <label>Writing Score (0–20): <input type="number" id="modalScore" min="0" max="20" style="width: 60px;"></label>
    <br><br>
    <button onclick="saveScore()">Save</button>
    <button onclick="printSubmission()">Print / PDF</button>
    <button onclick="downloadDoc()">Download DOC</button>
    <button class="close-btn" onclick="closeModal()">Close</button>
    <p id="saveMessage" style="color: green; display: none;">Saved!</p>
  </div>
</div>

<script>
  let currentId = null;
  let countdownInterval;

  function generatePin() {
    const pin = String(Math.floor(100000 + Math.random() * 900000));
    const expires = Date.now() + 30 * 60 * 1000;
    localStorage.setItem('examPin', JSON.stringify({ pin, expires }));

    document.getElementById("pinDisplay").textContent = "PIN: " + pin;
    startCountdown();

    fetch('https://script.google.com/macros/s/AKfycbzu6dlq_9Mez5Rcli02ulyR8mVdFLvxdU-SCgEDlleSPqOd3_W9IZEG6Gb5IhbB7xIXfA/exec', {
      method: 'POST',
      body: JSON.stringify({ pin, expires }),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.text())
    .then(data => console.log("Sheet response:", data))
    .catch(err => console.error("Failed to send to Sheets:", err));
  }

  function startCountdown() {
    clearInterval(countdownInterval);
    const pinData = JSON.parse(localStorage.getItem('examPin'));
    if (!pinData) return;

    countdownInterval = setInterval(() => {
      const now = Date.now();
      const diff = pinData.expires - now;

      if (diff <= 0) {
        document.getElementById("pinCountdown").textContent = "Expired";
        clearInterval(countdownInterval);
        return;
      }

      const minutes = Math.floor(diff / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);
      document.getElementById("pinCountdown").textContent = `${minutes}:${seconds.toString().padStart(2, '0')} remaining`;
    }, 1000);
  }

  window.onload = () => {
    const pin = localStorage.getItem('examPin');
    if (pin) {
      const { pin: code } = JSON.parse(pin);
      document.getElementById("pinDisplay").textContent = "PIN: " + code;
      startCountdown();
    }
    fetchSubsFromSheets();
  };
</script>
</body>
</html>
